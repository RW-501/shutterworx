<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Images</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://shutterworx.co/css/admin.css">
</head>
<body>

    <!-- Header -->
    <header class="bg-dark text-white text-center py-3">
        <h1>Photography Management System</h1>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <a class="navbar-brand" href="https://shutterworx.co/admin/images">Home</a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="../admin/dashboard.html">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="../admin/manage-images.html">Manage Images</a></li>
                    <li class="nav-item"><a class="nav-link" href="../admin/manage-events.html">Manage Events</a></li>
                    <li class="nav-item"><a class="nav-link" href="../admin/analytics.html">Analytics</a></li>
                    <li class="nav-item"><a class="nav-link" href="../admin/settings.html">Settings</a></li>
                </ul>
            </div>
        </nav>
    </header>
    <div class="container-fluid admin-container">


        <main class="dashboard-content">
    <div class="container my-4">
        <h2 class="my-4">Manage Images</h2>
        
        <form id="imageForm" class="mb-4">
            <div class="form-group">
                <label for="imageUpload">Upload Image</label>
                <input type="file" class="form-control-file" id="imageUpload" accept="image/*" required>
            </div>
            <button type="submit" class="btn btn-primary">Upload Image</button>
        </form>

        <h2>Uploaded Images</h2>


        <div class="search-filter-area">
            <input type="text" id="searchInput" placeholder="Search events..." class="form-control" onkeyup="filterEvents()">
            
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    Sort By
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="sortEvents('eventDate')">Event Date</a></li>
                    <li><a class="dropdown-item" href="#" onclick="sortEvents('lastUpdated')">Last Updated</a></li>
                    <li><a class="dropdown-item" href="#" onclick="sortEvents('eventName')">Event Name</a></li>
                </ul>
            </div>
        </div>
        
        <div id="eventGallery" class="row">
            <!-- Event cards will be inserted here dynamically -->
        </div>
        
        <!-- Modal for updating media info -->
        <div class="modal fade" id="updateMediaModal" tabindex="-1" aria-labelledby="updateMediaModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="updateMediaModalLabel">Update Media Information</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="updateMediaForm">
                            <div class="mb-3">
                                <label for="mediaTitle" class="form-label">Title</label>
                                <input type="text" class="form-control" id="mediaTitle" required>
                            </div>
                            <div class="mb-3">
                                <label for="mediaPrice" class="form-label">Price</label>
                                <input type="text" class="form-control" id="mediaPrice" required>
                            </div>
                            <div class="mb-3">
                                <label for="mediaFile" class="form-label">Choose New Image</label>
                                <input type="file" class="form-control" id="mediaFile">
                            </div>
                            <button type="submit" class="btn btn-primary">Update</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal for viewing image and thumbnail -->
        <div class="modal fade" id="viewImageModal" tabindex="-1" aria-labelledby="viewImageModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="viewImageModalLabel">View Image</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <img id="viewImage" src="" alt="Event Image" class="img-fluid">
                    </div>
                </div>
            </div>
        </div>
        




    </div>
</main>
</div>




<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Footer -->
    <footer id="site-footer">
        <div class="social-icons">
            <!-- Social media links dynamically added here -->
        </div>
        <footer-body>
            <p>&copy; 2024 <a href="https://shutterworx.co" style="color: #fff;">ShutterWorx</a>/ TechNoob All Rights Reserved.</p>
            <p><small><a href="https://shutterworx.co/privacy" style="color: #fff;">Privacy Policy</a> | <a href="https://shutterworx.co/terms" style="color: #fff;">Terms of Service</a></small></p>
        </footer-body>
    </footer>


    <!-- Include your firebaseConfig.js as a module -->
    <script type="module">
        import {  db, doc,getDoc, query, updateDoc,
    setDoc,     signInWithPopup,
    GoogleAuthProvider,
    FacebookAuthProvider,
    OAuthProvider,
    signOut,
    onAuthStateChanged,
    createUserWithEmailAndPassword,deleteDoc,
    signInWithEmailAndPassword,
    where, getDocs, storage, collection, auth, analytics } from 'https://shutterworx.co/js/firebaseConfig.js';
   
  
// Step 1: Fetch event media or user's events based on eventId
async function getEventMedia(eventId) {
    try {
        const membersMediaRef = collection(db, "Members_Media");
const q = query(membersMediaRef, where("eventID", "==", eventId));
const mediaSnapshot = await getDocs(q);


        if (!mediaSnapshot.empty) {
            mediaSnapshot.forEach((mediaDoc) => {
                const mediaData = mediaDoc.data();
                const originalUrl = mediaData.originalUrl;
                const eventId = mediaData.eventID;

                // Display the image in the gallery grouped by event
                displayImageInGallery(mediaData, originalUrl, eventId);
            });
        } else {
            const gallery = document.getElementById('eventGallery');
    
    // Check if the event ID already exists in the gallery
    let eventGroup = document.getElementById(`event-${eventId}`);
    
    // If event group does not exist, create it
    if (!eventGroup) {
        eventGroup = document.createElement('div');
        eventGroup.id = `event-${eventId}`;
        eventGroup.className = 'col-md-12 mb-4';
        gallery.appendChild(eventGroup);
    }
}
    } catch (error) {
        console.error("Error getting event media:", error);
    }
}

// Step 2: Display image in the gallery, grouped by event
function displayImageInGallery(mediaData, imageUrl, eventId) {
    const gallery = document.getElementById('eventGallery');
    
    // Check if the event ID already exists in the gallery
    let eventGroup = document.getElementById(`event-${eventId}`);
    if (!eventGroup) {
        eventGroup = document.createElement('div');
        eventGroup.id = `event-${eventId}`;
        eventGroup.className = 'col-md-12 mb-4';
        gallery.appendChild(eventGroup);
    }

    const newCard = document.createElement('div');
    newCard.className = 'col-md-4 mb-4';
    newCard.innerHTML = `
        <div class="card">
            <img src="${imageUrl}" class="card-img-top" alt="Event Image">
            <div class="card-body">
                <h5 class="card-title">${mediaData.title || "Untitled"}</h5>
                <p class="card-text">Price: ${mediaData.price || "N/A"}</p>
                <button class="btn btn-danger btn-sm main-delete-btn" )">Delete</button>
                <button class="btn btn-primary btn-sm main-update-btn" )">Update</button>
                <button class="btn btn-info btn-sm main-view-btn" >View</button>
                <button class="btn btn-primary btn-sm main-edit-btn" )">Edit</button>

            </div>
        </div>
    `;
    eventGroup.appendChild(newCard);
}

// Step 3: Filter events based on the search input
function filterEvents() {
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    const filteredEvents = eventsData.filter(event => event.eventName.toLowerCase().includes(searchInput));
    displayFilteredEvents(filteredEvents);
}

// Step 4: Display filtered events
function displayFilteredEvents(filteredEvents) {
    const gallery = document.getElementById('eventGallery');
    gallery.innerHTML = ''; // Clear existing gallery
    filteredEvents.forEach(event => {
        getEventMedia(event.eventId);
    });
}

// Step 5: Sort events based on the selected criteria
function sortEvents(criteria) {
    const sortedEvents = [...eventsData];
    sortedEvents.sort((a, b) => {
        if (criteria === 'eventDate') {
            return new Date(b.eventDate) - new Date(a.eventDate);
        } else if (criteria === 'lastUpdated') {
            return new Date(b.timestamp) - new Date(a.timestamp);
        } else if (criteria === 'eventName') {
            return a.eventName.localeCompare(b.eventName);
        }
    });

    displayFilteredEvents(sortedEvents);
}

// Step 6: Open modal for editing media info
function openUpdateMediaModal(eventId) {
    const modal = new bootstrap.Modal(document.getElementById('updateMediaModal'));
    const mediaTitle = document.getElementById('mediaTitle');
    const mediaPrice = document.getElementById('mediaPrice');

    const eventDocRef = doc(db, "Members_Media", eventId); // Correctly set the reference here
    getDoc(eventDocRef).then(docSnap => {
        if (docSnap.exists()) {
            const mediaData = docSnap.data();
            mediaTitle.value = mediaData.title || '';
            mediaPrice.value = mediaData.price || '';
        } else {
            console.error("No such document!");
        }
    }).catch((error) => {
        console.error("Error getting document:", error);
    });

    modal.show();
}

// Step 7: View image in modal
function viewImage(imageUrl) {
    const modal = new bootstrap.Modal(document.getElementById('viewImageModal'));
    document.getElementById('viewImage').src = imageUrl;
    modal.show();
}

// Step 8: Delete media

function deleteMedia(eventId, imageUrl) {
    const eventDocRef = doc(db, "Members_Media", eventId);
    deleteDoc(eventDocRef)
        .then(() => {
            showToast("Media deleted successfully.");
            location.reload(); // Refresh page to reflect the changes
        })
        .catch((error) => {
            console.error("Error deleting media:", error);
        });
}


async function getUserEvents(userId) {
    try {
        const eventsRef = collection(db, "Members_Events");
        const eventsQuery = query(eventsRef, where("userID", "==", userId));
        const eventsSnapshot = await getDocs(eventsQuery);
        let mediaPromises = [];
        let eventsData = [];
        if (!eventsSnapshot.empty) {
            eventsSnapshot.forEach((eventDoc) => {
                const eventData = eventDoc.data();
                eventsData.push(eventData);
                const eventId = eventDoc.id;
                mediaPromises.push(getEventMedia(eventId)); // Store all promises
            });

            // Now you can filter and sort based on the eventsData
            displayFilteredEvents(eventsData);
        } else {
            console.log("No events found for this user.");
        }
    } catch (error) {
        console.error("Error getting user events:", error);
    }
}














// Step 4: Handle the image upload and display
document.getElementById('imageForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const imageUpload = document.getElementById('imageUpload').files[0];

    // Create a new FileReader to display the image
    const reader = new FileReader();
    reader.onload = function(e) {
        const gallery = document.getElementById('imageGallery');
        const newCol = document.createElement('div');
        newCol.className = 'col-md-4 mb-4';
        newCol.innerHTML = `
            <div class="card">
                <img src="${e.target.result}" class="card-img-top" alt="Uploaded Image">
                <div class="card-body">
                    <button class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.parentElement.remove();">Delete</button>
                </div>
            </div>
        `;
        gallery.appendChild(newCol);
    };
    reader.readAsDataURL(imageUpload);

    // Clear the file input
    this.reset();
});



// This will be triggered on page load
window.onload = function() {
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('eventId');  // Get the 'eventId' from the URL query string
    const userId = document.getElementById("userIdDiv").innerText;

if(eventId){
   // Call getEventMedia, passing the eventId (if available)
   getEventMedia(eventId);
}else{
    // Get userId from the DOM
    console.log("userId:", userId);
    getUserEvents(userId)

}

    document.querySelectorAll('.main-delete-btn').forEach(button => {
    button.addEventListener('click', function() {
        const eventId = this.dataset.eventId;
        const imageUrl = this.dataset.imageUrl;
        deleteMedia(eventId, imageUrl);
    });
});

document.querySelectorAll('.main-update-btn').forEach(button => {
    button.addEventListener('click', function() {
        const eventId = this.dataset.eventId;
        const imageUrl = this.dataset.imageUrl;
        openUpdateMediaModal(eventId, imageUrl);
    });
});
document.querySelectorAll('.main-view-btn').forEach(button => {
    button.addEventListener('click', function() {
        const eventId = this.dataset.eventId;
        const imageUrl = this.dataset.imageUrl;
        viewImage(eventId, imageUrl);
    });
});


};

    </script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-GNSPWFHKVN"></script>

<script  type="module" src="https://shutterworx.co/js/main.js"></script>
<script  type="module" src="https://shutterworx.co/js/admin.js"></script>

</body>
</html>
